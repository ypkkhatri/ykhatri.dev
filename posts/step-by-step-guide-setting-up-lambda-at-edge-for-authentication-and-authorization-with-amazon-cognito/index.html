<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Step-by-Step Guide: Setting Up Lambda@Edge for Authentication & Authorization with Amazon Cognito | Yougeshwar Khatri</title><meta name=keywords content="aws lambda@edge,setup lambda@edge,cloudfront lambda@edge,serverless edge functions,aws edge computing tutorial,authentication,authorization,security,azure ad,lambda,auth,amazon cognito,identity provider,idp"><meta name=description content="A practical step-by-step guide to deploying and configuring AWS Lambda@Edge for authentication & authorization with Amazon Cognito (Federated via External Identity Provider). Learn how to secure your CloudFront distributions, validate JWT tokens at the edge, and deliver content faster with smarter request handling."><meta name=author content="Yougeshwar Khatri"><link rel=canonical href=https://ykhatri.dev/posts/step-by-step-guide-setting-up-lambda-at-edge-for-authentication-and-authorization-with-amazon-cognito/><link crossorigin=anonymous href=/assets/css/stylesheet.232d0ed6ed20fe1613a6c71adf1f7ef8d4ef6eacf01585f189c94460a307b892.css integrity="sha256-Iy0O1u0g/hYTpsca3x9++NTvbqzwFYXxiclEYKMHuJI=" rel="preload stylesheet" as=style><link rel=icon href=https://ykhatri.dev/images/logo.png><link rel=icon type=image/png sizes=16x16 href=https://ykhatri.dev/images/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ykhatri.dev/images/favicon-32x32.png><link rel=apple-touch-icon href=https://ykhatri.dev/images/apple-touch-icon.png><link rel=mask-icon href=https://ykhatri.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ykhatri.dev/posts/step-by-step-guide-setting-up-lambda-at-edge-for-authentication-and-authorization-with-amazon-cognito/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://ykhatri.dev/posts/step-by-step-guide-setting-up-lambda-at-edge-for-authentication-and-authorization-with-amazon-cognito/"><meta property="og:site_name" content="Yougeshwar Khatri"><meta property="og:title" content="Step-by-Step Guide: Setting Up Lambda@Edge for Authentication & Authorization with Amazon Cognito"><meta property="og:description" content="A practical step-by-step guide to deploying and configuring AWS Lambda@Edge for authentication & authorization with Amazon Cognito (Federated via External Identity Provider). Learn how to secure your CloudFront distributions, validate JWT tokens at the edge, and deliver content faster with smarter request handling."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-23T00:00:00+00:00"><meta property="article:modified_time" content="2025-08-23T00:00:00+00:00"><meta property="article:tag" content="AWS"><meta property="article:tag" content="Lambda"><meta property="article:tag" content="Lambda@Edge"><meta property="article:tag" content="CloudFront"><meta property="article:tag" content="Serverless"><meta property="article:tag" content="Edge Computing"><meta property="og:image" content="https://ykhatri.dev/images/p1/cover.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ykhatri.dev/images/p1/cover.webp"><meta name=twitter:title content="Step-by-Step Guide: Setting Up Lambda@Edge for Authentication & Authorization with Amazon Cognito"><meta name=twitter:description content="A practical step-by-step guide to deploying and configuring AWS Lambda@Edge for authentication & authorization with Amazon Cognito (Federated via External Identity Provider). Learn how to secure your CloudFront distributions, validate JWT tokens at the edge, and deliver content faster with smarter request handling."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ykhatri.dev/posts/"},{"@type":"ListItem","position":2,"name":"Step-by-Step Guide: Setting Up Lambda@Edge for Authentication \u0026 Authorization with Amazon Cognito","item":"https://ykhatri.dev/posts/step-by-step-guide-setting-up-lambda-at-edge-for-authentication-and-authorization-with-amazon-cognito/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Step-by-Step Guide: Setting Up Lambda@Edge for Authentication \u0026 Authorization with Amazon Cognito","name":"Step-by-Step Guide: Setting Up Lambda@Edge for Authentication \u0026 Authorization with Amazon Cognito","description":"A practical step-by-step guide to deploying and configuring AWS Lambda@Edge for authentication \u0026 authorization with Amazon Cognito (Federated via External Identity Provider). Learn how to secure your CloudFront distributions, validate JWT tokens at the edge, and deliver content faster with smarter request handling.","keywords":["aws lambda@edge","setup lambda@edge","cloudfront lambda@edge","serverless edge functions","aws edge computing tutorial","authentication","authorization","security","azure ad","lambda","auth","amazon cognito","identity provider","idp"],"articleBody":"Introduction When building modern applications, authentication and authorization play a crucial role. Traditionally, these checks happen on the application backend, introducing latency and extra load on your origin servers.\nWith Lambda@Edge, you can run custom auth logic at CloudFront edge locations, stopping unauthorized requests before they ever reach your application or S3 bucket in the first place.\nIn this guide, I’ll walk you through setting up Lambda@Edge to authenticate users, validate JWT tokens issued by Amazon Cognito as a Federated Identity Broker, and handle authorization. This practical, step-by-step approach will help you secure your application globally while keeping latency low by handling authentication and authorization at the edge.\nWhat is Lambda@Edge? Lambda@Edge is an AWS feature that lets you run Lambda functions at CloudFront edge locations worldwide. Instead of processing requests only in a central AWS region, you can intercept and modify requests and responses at the edge — reducing latency and enabling dynamic content manipulation functionality.\nWhy Use Lambda@Edge for Authentication \u0026 Authorization? Lower Latency: Auth logic runs closer to the user. Offload Origins: Unauthorized requests never hit your S3 bucket or backend. Global Enforcement: CloudFront edge locations enforce the policy everywhere. Flexible Policies: Validate JWT tokens, API keys, or IP allow lists. How Lambda@Edge Works Lambda@Edge integrates with CloudFront and can be triggered during four lifecycle events:\nViewer Request – when a user requests to CloudFront. Origin Request – before the request is sent to your origin server. Origin Response – after the origin sends a response back to CloudFront. Viewer Response – before CloudFront responds to the user. In this post, we define the process of authentication and authorization at the Viewer Request stage.\nPrerequisites You’ll be needing the following before we dive in, note that this post does not cover how to set up Amazon Cognito with an external Identity Provider (IdP). That configuration is assumed to be already in place.\nAn AWS account that has access to Lambda, CloudFront, S3, Amazon Cognito, and IAM. Basic understanding of AWS Lambda and CloudFront distributions. Amazon Cognito must be configured with an external Identity Provider (IdP), (e.g. Microsoft Entra ID). Amazon Cognito should be capable of issuing valid JWT tokens after authenticating against external IdP. You should already have Amazon Cognito User Pool created. With that foundation, we’ll now focus entirely on how to integrate Lambda@Edge with CloudFront and Amazon Cognito to enforce authentication and authorization.\nArchitecture Overview Before diving into the setup, let’s look at how authentication and authorization with Lambda@Edge and Amazon Cognito works at a high level.\nFigure 1: High-level architecture of authentication \u0026 authorization with Lambda@Edge with Amazon Cognito\nUser Request → A user tries to access your application via a CloudFront distribution. Lambda@Edge (Viewer Request) → The function intercepts the request before it reaches the origin. Authentication \u0026 Authorization → Lambda@Edge forwards incoming requests to Amazon Cognito and that will authenticate against an external Identity Provider (IdP). Once the user successfully signs in, Lambda@Edge validates the JWT token issued Amazon Cognito and authorize the request. If no/invalid token → the user is redirected to log in again. If valid → request continues. Authorized Request → Once authenticated and authorized, CloudFront fetches content from the origin S3 bucket. This flow ensures that only authenticated and authorized users can access your content while still benefiting from CloudFront’s low-latency, globally distributed edge network. Step-by-Step Setup Step 1: Create the IAM role Your Lambda@Edge function needs an execution role with the right permissions and a proper trust relationship.\nIAM Policy (Permissions): Attach the following policy to allow logging to CloudWatch:\n{ \"Version\": \"2012-10-17\", \"Statement\": [ { \"Action\": [ \"logs:CreateLogGroup\", \"logs:CreateLogStream\", \"logs:PutLogEvents\" ], \"Resource\": [ \"arn:aws:logs:us-east-1:*:log-group:/aws/lambda/my-lambda-auth-function:*\", \"arn:aws:logs:*:*:log-group:/aws/lambda/us-east-1.my-lambda-auth-function:*\" ], \"Effect\": \"Allow\" }, ] } Name the role something like LambdaEdgeExecutionRole, and attach this policy. If you need your function to call other AWS services (e.g., SSM, Secrets), you’ll have to extend the policy accordingly. Trust Relationship: Use the following trust relationship, so Lambda can assume the role:\n{ \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Allow\", \"Principal\": { \"Service\": [ \"lambda.amazonaws.com\", \"edgelambda.amazonaws.com\" ] }, \"Action\": \"sts:AssumeRole\" } ] } Step 2: Create a Lambda Function Go to the AWS Lambda Console in the N. Virginia (us-east-1) region.\nCreate a new function (e.g., MyLambdaAuthFunction).\nChoose runtime Node.js (or Python) and select architecture x86_64.\nAttach the IAM role you created earlier with the name LambdaEdgeExecutionRole.\nUpload the function in the form of a zip file, here is the directory structure:\nnode_modules/ lambda_fucntion.mjs Below is the example code for the auth lambda function:\n// lambda_fucntion.mjs 'use strict'; import axios from 'axios'; import { decode } from 'jsonwebtoken'; const COOKIE_KEY_ID_TOKEN = 'id_token'; // I assume you already loaded the values based on your design (e.g., SSM) // Start var cognitoAuthDomain = \"YOUR_COGNITO_AUTH_DOMAIN\"; // e.g., .auth..amazoncognito.com var cognitoClientId = \"YOUR_COGNITO_CLIENT_ID\"; // Cognito Client ID var redirectURI = \"YOUR_REDIRECT_URI\"; // Your custom domain e.g., Route53 or CloudFront distribution URL var cognitoIdentityProvider = \"YOUR_COGNITO_IDENTITY_PROVIDER\"; // Name of Identity provider (type OIDC) // END export async function handler(event) { const request = event.Records[0].cf.request; const token = getCookie(request.headers, COOKIE_KEY_ID_TOKEN); if (token) { // Check if token exists try { if (isTokenExpired(token)) { // Check if the token has expired, attempt to refresh it throw new Error(\"Token expired\"); } else { return request; // Token is valid, allow the request to pass through } } catch (err) { console.error('Token validation failed:', JSON.stringify(err)); return cognitoLoginRedirect(); } } const queryParams = getQueryParams(request.querystring); const state = queryParams.state; const code = queryParams.code; // Check: // 1. If the request contains an authorization code, exchange it for tokens and set them as cookies in the response. // 2. If there is no authorization code, redirect the user to the Cognito login. if (code \u0026\u0026 state) { const body = { grant_type: 'authorization_code', code, client_id: cognitoClientId, redirect_uri: redirectURI, }; try { const tokens = await requestCognitoToken(body); return setTokenCookiesAndRedirect(tokens); } catch (err) { console.error('Error retrieving tokens:', JSON.stringify(err)); return { status: '500', statusDescription: 'Internal Server Error', body: 'Authentication failed: ' + JSON.stringify(err), }; } } else { return cognitoLoginRedirect(); } } function setTokenCookiesAndRedirect(tokens) { const idTokenExp = decode(tokens.id_token, { complete: true }).payload.exp; const expiryInSeconds = idTokenExp ? idTokenExp - Math.floor(Date.now() / 1000) : 86400; // Default to 24 hour if no exp in id_token const expiresString = new Date(Date.now() + expiryInSeconds * 1000).toUTCString(); return { status: '302', statusDescription: 'Found', headers: { location: [{ key: 'Location', value: redirectURI, }], 'set-cookie': Object.entries(tokens).map(([key, value]) =\u003e { return { key: 'Set-Cookie', value: `${key}=${value}; Domain=${getDomain(redirectURI)}; Secure; Path=/; Max-Age=${expiryInSeconds}; Expires=${expiresString};`, }; }), }, }; } function cognitoLoginRedirect() { const state = getRandomString(32); const queryString = Object.entries({ response_type: 'code', client_id: cognitoClientId, identity_provider: cognitoIdentityProvider, scope: ['openid', 'profile', 'email'].join(' '), redirect_uri: redirectURI, state, }) .map(([k, v]) =\u003e `${encodeURIComponent(k)}=${encodeURIComponent(v)}`) .join('\u0026'); const response = { status: '302', statusDescription: 'Found', headers: { location: [{ key: 'Location', value: `https://${cognitoAuthDomain}/oauth2/authorize?${queryString}`, }], }, }; return response; } async function requestCognitoToken(body) { const tokensUrl = `https://${cognitoAuthDomain}/oauth2/token`; try { const response = await axios.post(tokensUrl, body, { headers: { 'Content-Type': 'application/x-www-form-urlencoded', }, }); return response.data; } catch (err) { console.error('Error fetching tokens:', JSON.stringify(err)); throw new Error(`Error fetching tokens: ${err.message}`); } } // Below are the utility functions you need to create, as I have skipped them from the block: // // 1. isTokenExpired(token) // → Extracts `payload.exp` from the JWT and validates expiry. // // 2. getRandomString(length) // → Generates a random alphanumeric string of the given length. // // 3. getQueryParams(queryString) // → Parses query parameters from a URL query string into an object. // // 4. getDomain(url) // → Extracts the base domain (e.g., example.com) from a full URL. // // 5. getCookie(headers, cookieName) // → Extracts the cookie by name from CloudFront request headers. Note: The above code has some redundancies and is written for clarity rather than efficiency. It demonstrates the high-level idea of the authentication and authorization concept with Amazon Cognito and JWT tokens validation. You can optimize it or extend it to support scopes, roles, or custom claims based on your application needs.\nAuthentication \u0026 JWT Flow with Lambda@Edge: The following points explain how the request flow works:\nInitial Authentication Request\nThe user accesses your application. Your Lambda@Edge function triggers a request to authenticate the user. The user is redirected to the Identity Provider (IdP) to log in. Receive Authorization Code\nAfter successful login, the IdP returns an authorization code to your application. Exchange Code for JWT Tokens\nYour Lambda function takes the authorization code and requests JWT tokens from Amazon Cognito. Cognito responds with ID token, access token, and refresh token. Store Tokens in Cookie \u0026 Redirect\nThe Lambda function stores the received tokens in secure cookies. The user is redirected to the original URL. Subsequent Requests – Token Validation\nWhen the user returns, the Lambda@Edge function sees the JWT tokens in the cookies. It validates the tokens to ensure they are authentic and not expired. Once validated, the request is allowed to pass through to your application. Below is the package.json file for the required packages for the lambda function:\n{ \"name\": \"my_lambda_auth\", \"version\": \"1.0.0\", \"author\": \"Yougeshwar Khatri\", \"license\": \"MIT\", \"description\": \"Layer for Lambda@Edge function\", \"scripts\": { \"zip\": \"rm -rf lambda_content.zip \u0026\u0026 zip -r lambda_content.zip ./node_modules ./lambda_function.mjs\" }, \"devDependencies\": { \"axios\": \"^1.11.0\", \"jsonwebtoken\": \"^9.0.2\" } } Build and Package: Run the following commands to install dependencies and create a zip file for deployment\n# Install project dependencies npm install # Build and create a zip package npm run zip Step 3: Create an S3 Bucket (Origin) Create an S3 bucket (e.g., MyLambdaEdgeAuthBucket). Upload sample files (e.g., index.html). Keep the bucket private. Step 4: Create a CloudFront Distribution Create a new distribution with the name MyDistribution\nSet your S3 bucket as the origin.\nSave the distribution.\nEdit the distribution again to add the behavior\nCreate behavior\nPath pattern: Default (*) Origin: Select S3 bucket origin Viewer protocol policy: Enable Redirect HTTP to HTTPS. Allowed HTTP methods: GET, HEAD, OPTIONS, PUT, POST, PATCH, DELETE Function associations: Viewer request Function type: Lambda@Edge Function ARN with version # It will be updated in next step Step 5: Deploy Lambda@Edge Open your Lambda function in us-east-1. Select Actions → Deploy to Lambda@Edge. Attach it to your CloudFront distribution on the Viewer Request event, and that will update the version in CloudFront distribution behavior. Deploy. Step 6: Test Your Setup Testing auth with Amazon Cognito requires a browser flow because tokens are issued after a successful login.\nOpen a browser and access your custom domain or CloudFront URL (e.g., https://d1234abcdef.cloudfront.net/). If the user is not authenticated, the application should redirect them to external IdP login page through Amazon Cognito. After login, Amazon Cognito issues the JWT tokens and redirects back to your CloudFront URL with the tokens included in secure cookies. Lambda@Edge validates the token at the Viewer Request stage: If valid → the request passes and content is served. If invalid/expired → the user sees a 403 Forbidden response. Logging \u0026 Debugging Debugging Lambda@Edge is often tricky, because logs are not tied to the AWS region where your Lambda@Edge is deployed (us-east-1). Instead:\nCloudWatch log groups are always created in request origin region, not in N. Virginia (us-east-1). The log groups appear in the AWS region closest to the request’s origin (e.g., if a user requests from Germany, logs will be in eu-central-1).\nThe log group follows the naming format:\n/aws/lambda/us-east-1. So if your function is called MyLambdaAuthFunction, the logs will be stored in the closest request’s origin region under:\n/aws/lambda/us-east-1.MyLambdaAuthFunction Limitations Keep these in mind when designing your auth logic:\nDeployment Region – Functions must be created in us-east-1. No Environment Variables – Use hard-coded values or versions or SSM. Package Size – Max 50 MB uncompressed, 1 MB inline zip. Execution Timeouts – 5s for viewer events, 30s for origin events. Runtimes – Only Node.js and Python are supported. Architecture – Only x86_64 (no ARM/Graviton). File System – Read-only /tmp directory, max 512 MB. Limited IAM Access – Avoid heavy AWS API calls. Conclusion By moving auth checks to the edge, you:\nBlock unauthorized requests early. Reduce load on your backend. Improve latency and scalability. Lambda@Edge is not a full replacement for centralized identity providers, but it’s an excellent way to add a first line of defense at the network edge.\nStart small — implement a static header check — then expand into JWT validation, deeper Cognito integration. Later, you can build on this with the refresh_token concept for more advanced scenarios.\nReferences Below are some useful resources and references that inspired this guide and provide additional context on Lambda@Edge, Amazon Cognito and external IdP (Azure AD) auth process.\nhttps://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-at-edge-function-restrictions.html https://docs.aws.amazon.com/cognito/latest/developerguide/token-endpoint.html https://docs.aws.amazon.com/cognito/latest/developerguide/federation-endpoints.html https://docs.aws.amazon.com/singlesignon/latest/userguide/how-to-connect-idp.html https://aws.amazon.com/blogs/networking-and-content-delivery/authorizationedge-using-cookies-protect-your-amazon-cloudfront-content-from-being-downloaded-by-unauthenticated-users/ ","wordCount":"2093","inLanguage":"en","image":"https://ykhatri.dev/images/p1/cover.webp","datePublished":"2025-08-23T00:00:00Z","dateModified":"2025-08-23T00:00:00Z","author":{"@type":"Person","name":"Yougeshwar Khatri"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ykhatri.dev/posts/step-by-step-guide-setting-up-lambda-at-edge-for-authentication-and-authorization-with-amazon-cognito/"},"publisher":{"@type":"Person","name":"Yougeshwar Khatri","logo":{"@type":"ImageObject","url":"https://ykhatri.dev/images/logo.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ykhatri.dev/ accesskey=h title="Yougeshwar Khatri (Alt + H)">Yougeshwar Khatri</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ykhatri.dev/about/ title=About><span>About</span></a></li><li><a href=https://ykhatri.dev/certs/ title=Certs><span>Certs</span></a></li><li><a href=https://ykhatri.dev/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://ykhatri.dev/contact/ title=Contact><span>Contact</span></a></li><li><a href=https://ykhatri.dev/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://ykhatri.dev/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Step-by-Step Guide: Setting Up Lambda@Edge for Authentication & Authorization with Amazon Cognito</h1><div class=post-description>A practical step-by-step guide to deploying and configuring AWS Lambda@Edge for authentication & authorization with Amazon Cognito (Federated via External Identity Provider). Learn how to secure your CloudFront distributions, validate JWT tokens at the edge, and deliver content faster with smarter request handling.</div><div class=post-meta><span title='2025-08-23 00:00:00 +0000 UTC'>August 23, 2025</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;Yougeshwar Khatri</div></header><figure class=entry-cover><img loading=eager src=https://ykhatri.dev/images/p1/cover.webp alt="Cover image for Lambda@Edge blog"></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#what-is-lambdaedge>What is Lambda@Edge?</a></li><li><a href=#why-use-lambdaedge-for-authentication--authorization>Why Use Lambda@Edge for Authentication & Authorization?</a><ul><li><a href=#how-lambdaedge-works>How Lambda@Edge Works</a></li></ul></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#architecture-overview>Architecture Overview</a></li><li><a href=#step-by-step-setup>Step-by-Step Setup</a><ul><li><a href=#step-1-create-the-iam-role>Step 1: Create the IAM role</a></li><li><a href=#step-2-create-a-lambda-function>Step 2: Create a Lambda Function</a></li><li><a href=#step-3-create-an-s3-bucket-origin>Step 3: Create an S3 Bucket (Origin)</a></li><li><a href=#step-4-create-a-cloudfront-distribution>Step 4: Create a CloudFront Distribution</a></li><li><a href=#step-5-deploy-lambdaedge>Step 5: Deploy Lambda@Edge</a></li><li><a href=#step-6-test-your-setup>Step 6: Test Your Setup</a></li></ul></li><li><a href=#logging--debugging>Logging & Debugging</a></li><li><a href=#limitations>Limitations</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#references>References</a></li></ul></nav></div></details></div><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>When building modern applications, <strong>authentication and authorization</strong> play a crucial role. Traditionally, these checks happen on the application backend, introducing <strong>latency</strong> and extra load on your origin servers.</p><p>With <strong>Lambda@Edge</strong>, you can run custom <strong>auth logic at CloudFront edge locations</strong>, stopping unauthorized requests before they ever reach your application or S3 bucket in the first place.</p><p>In this guide, I’ll walk you through <strong>setting up Lambda@Edge to authenticate users, validate JWT tokens issued by Amazon Cognito as a Federated Identity Broker, and handle authorization</strong>. This practical, step-by-step approach will help you secure your application globally while keeping latency low by handling authentication and authorization at the edge.</p><h2 id=what-is-lambdaedge>What is Lambda@Edge?<a hidden class=anchor aria-hidden=true href=#what-is-lambdaedge>#</a></h2><p><strong>Lambda@Edge</strong> is an AWS feature that lets you run <strong>Lambda functions at CloudFront edge locations</strong> worldwide. Instead of processing requests only in a central AWS region, you can intercept and modify requests and responses at the edge — reducing latency and enabling dynamic content manipulation functionality.</p><h2 id=why-use-lambdaedge-for-authentication--authorization>Why Use Lambda@Edge for Authentication & Authorization?<a hidden class=anchor aria-hidden=true href=#why-use-lambdaedge-for-authentication--authorization>#</a></h2><ul><li><strong>Lower Latency:</strong> Auth logic runs closer to the user.</li><li><strong>Offload Origins:</strong> Unauthorized requests never hit your S3 bucket or backend.</li><li><strong>Global Enforcement:</strong> CloudFront edge locations enforce the policy everywhere.</li><li><strong>Flexible Policies:</strong> Validate JWT tokens, API keys, or IP allow lists.</li></ul><h3 id=how-lambdaedge-works>How Lambda@Edge Works<a hidden class=anchor aria-hidden=true href=#how-lambdaedge-works>#</a></h3><p>Lambda@Edge integrates with CloudFront and can be triggered during four lifecycle events:</p><ul><li><strong>Viewer Request</strong> – when a user requests to CloudFront.</li><li><strong>Origin Request</strong> – before the request is sent to your origin server.</li><li><strong>Origin Response</strong> – after the origin sends a response back to CloudFront.</li><li><strong>Viewer Response</strong> – before CloudFront responds to the user.</li></ul><p>In this post, we define the process of authentication and authorization at the <strong>Viewer Request</strong> stage.</p><h2 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h2><p>You&rsquo;ll be needing the following before we dive in, <strong>note</strong> that this post does not cover how to set up Amazon Cognito with an external Identity Provider (IdP). That configuration is assumed to be already in place.</p><ul><li>An <strong>AWS account</strong> that has access to <strong>Lambda, CloudFront, S3, Amazon Cognito, and IAM</strong>.</li><li>Basic understanding of <strong>AWS Lambda</strong> and <strong>CloudFront distributions</strong>.</li><li><strong>Amazon Cognito</strong> must be configured with an <strong>external Identity Provider (IdP)</strong>, (e.g. Microsoft Entra ID).</li><li>Amazon Cognito should be capable of issuing valid <strong>JWT tokens</strong> after authenticating against external IdP.</li><li>You should already have Amazon Cognito User Pool created.</li></ul><p>With that foundation, we’ll now focus entirely on how to integrate <strong>Lambda@Edge with CloudFront and Amazon Cognito</strong> to enforce authentication and authorization.</p><h2 id=architecture-overview>Architecture Overview<a hidden class=anchor aria-hidden=true href=#architecture-overview>#</a></h2><p>Before diving into the setup, let’s look at how authentication and authorization with Lambda@Edge and Amazon Cognito works at a high level.</p><p><img alt=alt loading=lazy src=/images/p1/diagram.webp>
<em>Figure 1: High-level architecture of authentication & authorization with Lambda@Edge with Amazon Cognito</em></p><ol><li><strong>User Request</strong> → A user tries to access your application via a <strong>CloudFront distribution</strong>.</li><li><strong>Lambda@Edge (Viewer Request)</strong> → The function intercepts the request before it reaches the origin.</li><li><strong>Authentication & Authorization</strong> → Lambda@Edge forwards incoming requests to <strong>Amazon Cognito</strong> and that will authenticate against an <strong>external Identity Provider (IdP)</strong>. Once the user successfully signs in, Lambda@Edge validates the JWT token issued Amazon Cognito and authorize the request.<ul><li>If no/invalid token → the user is redirected to log in again.</li><li>If valid → request continues.</li></ul></li><li><strong>Authorized Request</strong> → Once authenticated and authorized, CloudFront fetches content from the <strong>origin S3 bucket</strong>.
This flow ensures that only authenticated and authorized users can access your content while still benefiting from CloudFront’s low-latency, globally distributed edge network.</li></ol><h2 id=step-by-step-setup>Step-by-Step Setup<a hidden class=anchor aria-hidden=true href=#step-by-step-setup>#</a></h2><h3 id=step-1-create-the-iam-role>Step 1: Create the IAM role<a hidden class=anchor aria-hidden=true href=#step-1-create-the-iam-role>#</a></h3><p>Your Lambda@Edge function needs an execution role with the right permissions and a proper trust relationship.</p><p><strong>IAM Policy (Permissions):</strong> Attach the following policy to allow logging to CloudWatch:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Version&#34;</span>: <span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Statement&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Action&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;logs:CreateLogGroup&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;logs:CreateLogStream&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;logs:PutLogEvents&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Resource&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;arn:aws:logs:us-east-1:*:log-group:/aws/lambda/my-lambda-auth-function:*&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;arn:aws:logs:*:*:log-group:/aws/lambda/us-east-1.my-lambda-auth-function:*&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Effect&#34;</span>: <span style=color:#e6db74>&#34;Allow&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>Name the role something like <code>LambdaEdgeExecutionRole</code>, and attach this policy.</li><li>If you need your function to call other AWS services (e.g., SSM, Secrets), you’ll have to extend the policy accordingly.</li></ul><p><strong>Trust Relationship:</strong> Use the following trust relationship, so Lambda can assume the role:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Version&#34;</span>: <span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Statement&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Effect&#34;</span>: <span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Principal&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;Service&#34;</span>: [
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;lambda.amazonaws.com&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;edgelambda.amazonaws.com&#34;</span>
</span></span><span style=display:flex><span>                ]
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Action&#34;</span>: <span style=color:#e6db74>&#34;sts:AssumeRole&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=step-2-create-a-lambda-function>Step 2: Create a Lambda Function<a hidden class=anchor aria-hidden=true href=#step-2-create-a-lambda-function>#</a></h3><ul><li><p>Go to the AWS Lambda Console in the N. Virginia (<code>us-east-1</code>) region.</p></li><li><p>Create a new function (e.g., <code>MyLambdaAuthFunction</code>).</p></li><li><p>Choose runtime Node.js (or Python) and select architecture <code>x86_64</code>.</p></li><li><p>Attach the IAM role you created earlier with the name <code>LambdaEdgeExecutionRole</code>.</p></li><li><p>Upload the function in the form of a zip file, here is the directory structure:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>node_modules/
</span></span><span style=display:flex><span>lambda_fucntion.mjs
</span></span></code></pre></div></li></ul><p>Below is the example code for the auth lambda function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// lambda_fucntion.mjs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#e6db74>&#39;use strict&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>axios</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;axios&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>decode</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;jsonwebtoken&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>COOKIE_KEY_ID_TOKEN</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;id_token&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// I assume you already loaded the values based on your design (e.g., SSM)
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Start
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cognitoAuthDomain</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;YOUR_COGNITO_AUTH_DOMAIN&#34;</span>; <span style=color:#75715e>// e.g., &lt;YUOR_CUSTOM_DOMAIN&gt;.auth.&lt;REGION&gt;.amazoncognito.com
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cognitoClientId</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;YOUR_COGNITO_CLIENT_ID&#34;</span>; <span style=color:#75715e>// Cognito Client ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>redirectURI</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;YOUR_REDIRECT_URI&#34;</span>; <span style=color:#75715e>// Your custom domain e.g., Route53 or CloudFront distribution URL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cognitoIdentityProvider</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;YOUR_COGNITO_IDENTITY_PROVIDER&#34;</span>; <span style=color:#75715e>// Name of Identity provider (type OIDC)
</span></span></span><span style=display:flex><span><span style=color:#75715e>// END
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>request</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>Records</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>cf</span>.<span style=color:#a6e22e>request</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getCookie</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>headers</span>, <span style=color:#a6e22e>COOKIE_KEY_ID_TOKEN</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>token</span>) { <span style=color:#75715e>// Check if token exists
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isTokenExpired</span>(<span style=color:#a6e22e>token</span>)) { <span style=color:#75715e>// Check if the token has expired, attempt to refresh it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;Token expired&#34;</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>request</span>; <span style=color:#75715e>// Token is valid, allow the request to pass through
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Token validation failed:&#39;</span>, <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>err</span>));
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cognitoLoginRedirect</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>queryParams</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getQueryParams</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>querystring</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>queryParams</span>.<span style=color:#a6e22e>state</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>code</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>queryParams</span>.<span style=color:#a6e22e>code</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Check:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 1. If the request contains an authorization code, exchange it for tokens and set them as cookies in the response.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 2. If there is no authorization code, redirect the user to the Cognito login.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>code</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>state</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>body</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>grant_type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;authorization_code&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>code</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>client_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>cognitoClientId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>redirect_uri</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>redirectURI</span>,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tokens</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>requestCognitoToken</span>(<span style=color:#a6e22e>body</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>setTokenCookiesAndRedirect</span>(<span style=color:#a6e22e>tokens</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Error retrieving tokens:&#39;</span>, <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>err</span>));
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;500&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>statusDescription</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Internal Server Error&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Authentication failed: &#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>err</span>),
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cognitoLoginRedirect</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>setTokenCookiesAndRedirect</span>(<span style=color:#a6e22e>tokens</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>idTokenExp</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>decode</span>(<span style=color:#a6e22e>tokens</span>.<span style=color:#a6e22e>id_token</span>, { <span style=color:#a6e22e>complete</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> }).<span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>exp</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expiryInSeconds</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>idTokenExp</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>idTokenExp</span> <span style=color:#f92672>-</span> Math.<span style=color:#a6e22e>floor</span>(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>) <span style=color:#f92672>:</span> <span style=color:#ae81ff>86400</span>; <span style=color:#75715e>// Default to 24 hour if no exp in id_token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expiresString</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>+</span> <span style=color:#a6e22e>expiryInSeconds</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>).<span style=color:#a6e22e>toUTCString</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;302&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>statusDescription</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Found&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>location</span><span style=color:#f92672>:</span> [{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>key</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Location&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>redirectURI</span>,
</span></span><span style=display:flex><span>      }],
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;set-cookie&#39;</span><span style=color:#f92672>:</span> Object.<span style=color:#a6e22e>entries</span>(<span style=color:#a6e22e>tokens</span>).<span style=color:#a6e22e>map</span>(([<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>]) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>key</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Set-Cookie&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>key</span><span style=color:#e6db74>}</span><span style=color:#e6db74>=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>value</span><span style=color:#e6db74>}</span><span style=color:#e6db74>; Domain=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>getDomain</span>(<span style=color:#a6e22e>redirectURI</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>; Secure; Path=/; Max-Age=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>expiryInSeconds</span><span style=color:#e6db74>}</span><span style=color:#e6db74>; Expires=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>expiresString</span><span style=color:#e6db74>}</span><span style=color:#e6db74>;`</span>,
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      }),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>cognitoLoginRedirect</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getRandomString</span>(<span style=color:#ae81ff>32</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>queryString</span> <span style=color:#f92672>=</span> Object.<span style=color:#a6e22e>entries</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>response_type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;code&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>cognitoClientId</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>identity_provider</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>cognitoIdentityProvider</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>scope</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;openid&#39;</span>, <span style=color:#e6db74>&#39;profile&#39;</span>, <span style=color:#e6db74>&#39;email&#39;</span>].<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39; &#39;</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>redirect_uri</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>redirectURI</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span>,
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>map</span>(([<span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span>]) =&gt; <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span>encodeURIComponent(<span style=color:#a6e22e>k</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>=</span><span style=color:#e6db74>${</span>encodeURIComponent(<span style=color:#a6e22e>v</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;&amp;&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;302&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>statusDescription</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Found&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>location</span><span style=color:#f92672>:</span> [{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>key</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Location&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`https://</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>cognitoAuthDomain</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/oauth2/authorize?</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>queryString</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>      }],
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>response</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>requestCognitoToken</span>(<span style=color:#a6e22e>body</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tokensUrl</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`https://</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>cognitoAuthDomain</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/oauth2/token`</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>axios</span>.<span style=color:#a6e22e>post</span>(<span style=color:#a6e22e>tokensUrl</span>, <span style=color:#a6e22e>body</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/x-www-form-urlencoded&#39;</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Error fetching tokens:&#39;</span>, <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>err</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Error fetching tokens: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>message</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Below are the utility functions you need to create, as I have skipped them from the block:
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 1. isTokenExpired(token)
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    → Extracts `payload.exp` from the JWT and validates expiry.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 2. getRandomString(length)
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    → Generates a random alphanumeric string of the given length.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 3. getQueryParams(queryString)
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    → Parses query parameters from a URL query string into an object.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 4. getDomain(url)
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    → Extracts the base domain (e.g., example.com) from a full URL.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 5. getCookie(headers, cookieName)
</span></span></span><span style=display:flex><span><span style=color:#75715e>//    → Extracts the cookie by name from CloudFront request headers.
</span></span></span></code></pre></div><blockquote><p><em><strong>Note:</strong> The above code has some redundancies and is written for clarity rather than efficiency. It demonstrates the high-level idea of the authentication and authorization concept with Amazon Cognito and JWT tokens validation. You can optimize it or extend it to support scopes, roles, or custom claims based on your application needs.</em></p></blockquote><p><strong>Authentication & JWT Flow with Lambda@Edge:</strong> The following points explain how the request flow works:</p><ol><li><p><strong>Initial Authentication Request</strong></p><ul><li>The user accesses your application.</li><li>Your Lambda@Edge function triggers a request to authenticate the user.</li><li>The user is redirected to the Identity Provider (IdP) to log in.</li></ul></li><li><p><strong>Receive Authorization Code</strong></p><ul><li>After successful login, the IdP returns an <strong>authorization code</strong> to your application.</li></ul></li><li><p><strong>Exchange Code for JWT Tokens</strong></p><ul><li>Your Lambda function takes the authorization code and requests <strong>JWT tokens</strong> from Amazon Cognito.</li><li>Cognito responds with ID token, access token, and refresh token.</li></ul></li><li><p><strong>Store Tokens in Cookie & Redirect</strong></p><ul><li>The Lambda function stores the received tokens in <strong>secure cookies</strong>.</li><li>The user is redirected to the original URL.</li></ul></li><li><p><strong>Subsequent Requests – Token Validation</strong></p><ul><li>When the user returns, the Lambda@Edge function sees the JWT tokens in the cookies.</li><li>It <strong>validates the tokens</strong> to ensure they are authentic and not expired.</li><li>Once validated, the request is allowed to pass through to your application.</li></ul></li></ol><p>Below is the <code>package.json</code> file for the required packages for the lambda function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;my_lambda_auth&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0.0&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;author&#34;</span>: <span style=color:#e6db74>&#34;Yougeshwar Khatri&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;license&#34;</span>: <span style=color:#e6db74>&#34;MIT&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;Layer for Lambda@Edge function&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;scripts&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;zip&#34;</span>: <span style=color:#e6db74>&#34;rm -rf lambda_content.zip &amp;&amp; zip -r lambda_content.zip ./node_modules ./lambda_function.mjs&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;devDependencies&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;axios&#34;</span>: <span style=color:#e6db74>&#34;^1.11.0&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;jsonwebtoken&#34;</span>: <span style=color:#e6db74>&#34;^9.0.2&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Build and Package</strong>: Run the following commands to install dependencies and create a zip file for deployment</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Install project dependencies</span>
</span></span><span style=display:flex><span>npm install
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Build and create a zip package</span>
</span></span><span style=display:flex><span>npm run zip
</span></span></code></pre></div><h3 id=step-3-create-an-s3-bucket-origin>Step 3: Create an S3 Bucket (Origin)<a hidden class=anchor aria-hidden=true href=#step-3-create-an-s3-bucket-origin>#</a></h3><ul><li>Create an S3 bucket (e.g., <code>MyLambdaEdgeAuthBucket</code>).</li><li>Upload sample files (e.g., <code>index.html</code>).</li><li>Keep the bucket private.</li></ul><h3 id=step-4-create-a-cloudfront-distribution>Step 4: Create a CloudFront Distribution<a hidden class=anchor aria-hidden=true href=#step-4-create-a-cloudfront-distribution>#</a></h3><ul><li><p>Create a new distribution with the name <code>MyDistribution</code></p></li><li><p>Set your S3 bucket as the origin.</p></li><li><p>Save the distribution.</p></li><li><p>Edit the distribution again to add the behavior</p></li><li><p>Create behavior</p><ul><li><strong>Path pattern:</strong> <code>Default (*)</code></li><li><strong>Origin:</strong> Select S3 bucket origin</li><li><strong>Viewer protocol policy:</strong> Enable Redirect HTTP to HTTPS.</li><li><strong>Allowed HTTP methods:</strong> <code>GET, HEAD, OPTIONS, PUT, POST, PATCH, DELETE</code></li><li><strong>Function associations:</strong> Viewer request<ul><li><strong>Function type:</strong> Lambda@Edge</li><li><strong>Function ARN</strong> with version # It will be updated in next step</li></ul></li></ul></li></ul><h3 id=step-5-deploy-lambdaedge>Step 5: Deploy Lambda@Edge<a hidden class=anchor aria-hidden=true href=#step-5-deploy-lambdaedge>#</a></h3><ul><li>Open your Lambda function in <code>us-east-1</code>.</li><li>Select <code>Actions → Deploy to Lambda@Edge</code>.</li><li>Attach it to your <strong>CloudFront distribution</strong> on the <strong>Viewer Request</strong> event, and that will update the version in CloudFront distribution behavior.</li><li>Deploy.</li></ul><h3 id=step-6-test-your-setup>Step 6: Test Your Setup<a hidden class=anchor aria-hidden=true href=#step-6-test-your-setup>#</a></h3><p>Testing auth with Amazon Cognito requires a browser flow because tokens are issued after a successful login.</p><ol><li>Open a browser and access your custom domain or CloudFront URL (e.g., <a href=https://d1234abcdef.cloudfront.net/>https://d1234abcdef.cloudfront.net/</a>).</li><li>If the user is not authenticated, the application should redirect them to external IdP login page through Amazon Cognito.</li><li>After login, Amazon Cognito issues the JWT tokens and redirects back to your CloudFront URL with the tokens included in secure cookies.</li><li>Lambda@Edge validates the token at the Viewer Request stage:<ul><li>If valid → the request passes and content is served.</li><li>If invalid/expired → the user sees a 403 Forbidden response.</li></ul></li></ol><h2 id=logging--debugging>Logging & Debugging<a hidden class=anchor aria-hidden=true href=#logging--debugging>#</a></h2><p>Debugging <strong>Lambda@Edge</strong> is often tricky, because logs are <strong>not tied to the AWS region where your Lambda@Edge is deployed (us-east-1)</strong>. Instead:</p><ul><li><p>CloudWatch log groups are always created in <strong>request origin region, not in N. Virginia</strong> (<code>us-east-1</code>). The log groups appear in the AWS region closest to the request’s origin (e.g., if a user requests from Germany, logs will be in <code>eu-central-1</code>).</p></li><li><p>The log group follows the naming format:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>/aws/lambda/us-east-1.&lt;function-name&gt;
</span></span></code></pre></div><p>So if your function is called <code>MyLambdaAuthFunction</code>, the logs will be stored in the closest request&rsquo;s origin region under:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>/aws/lambda/us-east-1.MyLambdaAuthFunction
</span></span></code></pre></div></li></ul><h2 id=limitations>Limitations<a hidden class=anchor aria-hidden=true href=#limitations>#</a></h2><p>Keep these in mind when designing your auth logic:</p><ul><li><strong>Deployment Region</strong> – Functions must be created in <code>us-east-1</code>.</li><li><strong>No Environment Variables</strong> – Use hard-coded values or versions or SSM.</li><li><strong>Package Size</strong> – Max <code>50 MB</code> uncompressed, <code>1 MB</code> inline zip.</li><li><strong>Execution Timeouts</strong> – <code>5s</code> for viewer events, <code>30s</code> for origin events.</li><li><strong>Runtimes</strong> – Only <strong>Node.js</strong> and <strong>Python</strong> are supported.</li><li><strong>Architecture</strong> – Only <code>x86_64</code> (no ARM/Graviton).</li><li><strong>File System</strong> – Read-only <code>/tmp</code> directory, max 512 MB.</li><li><strong>Limited IAM Access</strong> – Avoid heavy AWS API calls.</li></ul><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>By moving auth checks to the edge, you:</p><ul><li>Block unauthorized requests early.</li><li>Reduce load on your backend.</li><li>Improve latency and scalability.</li></ul><p><strong>Lambda@Edge</strong> is not a full replacement for centralized identity providers, but it’s an excellent way to add a <strong>first line of defense at the network edge</strong>.</p><p>Start small — implement a static header check — then expand into JWT validation, deeper Cognito integration. Later, you can build on this with the <code>refresh_token</code> concept for more advanced scenarios.</p><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><p>Below are some useful resources and references that inspired this guide and provide additional context on Lambda@Edge, Amazon Cognito and external IdP (Azure AD) auth process.</p><ul><li><a href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-at-edge-function-restrictions.html>https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-at-edge-function-restrictions.html</a></li><li><a href=https://docs.aws.amazon.com/cognito/latest/developerguide/token-endpoint.html>https://docs.aws.amazon.com/cognito/latest/developerguide/token-endpoint.html</a></li><li><a href=https://docs.aws.amazon.com/cognito/latest/developerguide/federation-endpoints.html>https://docs.aws.amazon.com/cognito/latest/developerguide/federation-endpoints.html</a></li><li><a href=https://docs.aws.amazon.com/singlesignon/latest/userguide/how-to-connect-idp.html>https://docs.aws.amazon.com/singlesignon/latest/userguide/how-to-connect-idp.html</a></li><li><a href=https://aws.amazon.com/blogs/networking-and-content-delivery/authorizationedge-using-cookies-protect-your-amazon-cloudfront-content-from-being-downloaded-by-unauthenticated-users/>https://aws.amazon.com/blogs/networking-and-content-delivery/authorizationedge-using-cookies-protect-your-amazon-cloudfront-content-from-being-downloaded-by-unauthenticated-users/</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://ykhatri.dev/tags/aws/>AWS</a></li><li><a href=https://ykhatri.dev/tags/lambda/>Lambda</a></li><li><a href=https://ykhatri.dev/tags/lambda@edge/>Lambda@Edge</a></li><li><a href=https://ykhatri.dev/tags/cloudfront/>CloudFront</a></li><li><a href=https://ykhatri.dev/tags/serverless/>Serverless</a></li><li><a href=https://ykhatri.dev/tags/edge-computing/>Edge Computing</a></li><li><a href=https://ykhatri.dev/tags/authentication/>Authentication</a></li><li><a href=https://ykhatri.dev/tags/authorization/>Authorization</a></li><li><a href=https://ykhatri.dev/tags/security/>Security</a></li><li><a href=https://ykhatri.dev/tags/auth/>Auth</a></li><li><a href=https://ykhatri.dev/tags/amazon-cognito/>Amazon Cognito</a></li><li><a href=https://ykhatri.dev/tags/identity-provider/>Identity Provider</a></li></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Step-by-Step Guide: Setting Up Lambda@Edge for Authentication & Authorization with Amazon Cognito on x" href="https://x.com/intent/tweet/?text=Step-by-Step%20Guide%3a%20Setting%20Up%20Lambda%40Edge%20for%20Authentication%20%26%20Authorization%20with%20Amazon%20Cognito&amp;url=https%3a%2f%2fykhatri.dev%2fposts%2fstep-by-step-guide-setting-up-lambda-at-edge-for-authentication-and-authorization-with-amazon-cognito%2f&amp;hashtags=AWS%2cLambda%2cLambda%40Edge%2cCloudFront%2cServerless%2cEdgeComputing%2cAuthentication%2cAuthorization%2cSecurity%2cAuth%2cAmazonCognito%2cIdentityProvider"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Step-by-Step Guide: Setting Up Lambda@Edge for Authentication & Authorization with Amazon Cognito on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fykhatri.dev%2fposts%2fstep-by-step-guide-setting-up-lambda-at-edge-for-authentication-and-authorization-with-amazon-cognito%2f&amp;title=Step-by-Step%20Guide%3a%20Setting%20Up%20Lambda%40Edge%20for%20Authentication%20%26%20Authorization%20with%20Amazon%20Cognito&amp;summary=Step-by-Step%20Guide%3a%20Setting%20Up%20Lambda%40Edge%20for%20Authentication%20%26%20Authorization%20with%20Amazon%20Cognito&amp;source=https%3a%2f%2fykhatri.dev%2fposts%2fstep-by-step-guide-setting-up-lambda-at-edge-for-authentication-and-authorization-with-amazon-cognito%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Step-by-Step Guide: Setting Up Lambda@Edge for Authentication & Authorization with Amazon Cognito on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fykhatri.dev%2fposts%2fstep-by-step-guide-setting-up-lambda-at-edge-for-authentication-and-authorization-with-amazon-cognito%2f&title=Step-by-Step%20Guide%3a%20Setting%20Up%20Lambda%40Edge%20for%20Authentication%20%26%20Authorization%20with%20Amazon%20Cognito"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Step-by-Step Guide: Setting Up Lambda@Edge for Authentication & Authorization with Amazon Cognito on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fykhatri.dev%2fposts%2fstep-by-step-guide-setting-up-lambda-at-edge-for-authentication-and-authorization-with-amazon-cognito%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Step-by-Step Guide: Setting Up Lambda@Edge for Authentication & Authorization with Amazon Cognito on whatsapp" href="https://api.whatsapp.com/send?text=Step-by-Step%20Guide%3a%20Setting%20Up%20Lambda%40Edge%20for%20Authentication%20%26%20Authorization%20with%20Amazon%20Cognito%20-%20https%3a%2f%2fykhatri.dev%2fposts%2fstep-by-step-guide-setting-up-lambda-at-edge-for-authentication-and-authorization-with-amazon-cognito%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Step-by-Step Guide: Setting Up Lambda@Edge for Authentication & Authorization with Amazon Cognito on telegram" href="https://telegram.me/share/url?text=Step-by-Step%20Guide%3a%20Setting%20Up%20Lambda%40Edge%20for%20Authentication%20%26%20Authorization%20with%20Amazon%20Cognito&amp;url=https%3a%2f%2fykhatri.dev%2fposts%2fstep-by-step-guide-setting-up-lambda-at-edge-for-authentication-and-authorization-with-amazon-cognito%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Step-by-Step Guide: Setting Up Lambda@Edge for Authentication & Authorization with Amazon Cognito on ycombinator" href="https://news.ycombinator.com/submitlink?t=Step-by-Step%20Guide%3a%20Setting%20Up%20Lambda%40Edge%20for%20Authentication%20%26%20Authorization%20with%20Amazon%20Cognito&u=https%3a%2f%2fykhatri.dev%2fposts%2fstep-by-step-guide-setting-up-lambda-at-edge-for-authentication-and-authorization-with-amazon-cognito%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><br><div id=giscus-container></div><script>const currentTheme=localStorage.getItem("pref-theme")||"light",giscusScript=document.createElement("script");giscusScript.src="https://giscus.app/client.js",giscusScript.setAttribute("data-repo","ypkkhatri/ykhatri-dev-posts-comments"),giscusScript.setAttribute("data-repo-id","R_kgDOPhKOew"),giscusScript.setAttribute("data-category","General"),giscusScript.setAttribute("data-category-id","DIC_kwDOPhKOe84CuYq6"),giscusScript.setAttribute("data-mapping","pathname"),giscusScript.setAttribute("data-strict","0"),giscusScript.setAttribute("data-reactions-enabled","0"),giscusScript.setAttribute("data-emit-metadata","0"),giscusScript.setAttribute("data-input-position","top"),giscusScript.setAttribute("data-theme",currentTheme),giscusScript.setAttribute("data-lang","en"),giscusScript.setAttribute("data-loading","lazy"),giscusScript.crossOrigin="anonymous",giscusScript.async=!0,document.getElementById("giscus-container").appendChild(giscusScript);function updateGiscusTheme(){const t=localStorage.getItem("pref-theme"),e=document.querySelector("iframe.giscus-frame");e&&e.contentWindow.postMessage({giscus:{setConfig:{theme:t}}},"https://giscus.app")}window.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("theme-toggle");e&&e.addEventListener("click",()=>updateGiscusTheme())})</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://ykhatri.dev/>Yougeshwar Khatri</a></span> ·
<span><a href=/privacy-policy/>Privacy Policy</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script src=https://challenges.cloudflare.com/turnstile/v0/api.js async defer></script></body></html>